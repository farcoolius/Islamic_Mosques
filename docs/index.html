<!DOCTYPE html>
<html>
<head>
  <title>Islamic Mosques in Seattle</title>
  <script src="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; }

    #map {
      position: absolute;
      top: 0; bottom: 0;
      width: 100%;
    }

    #info {
      position: absolute;
      top: 0;
      left: 0;
      width: 350px;
      margin: 10px;
      padding: 10px;
      background-color: #ffffff;
      border-radius: 5px;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 12px;
      line-height: 1.5;
      color: #000000;
      z-index: 1;
    }

    #popup { padding: 10px; }

    #name, #mosque_name, #year_established {
      width: 100%;
      height: 20px;
      margin-bottom: 10px;
    }

    #content {
      width: 100%;
      height: 45px;
      margin-bottom: 10px;
    }

    #submit { float: right; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="info">
    <h3>Islamic Mosques in Seattle</h3>
    <h4>Farhan Hassan | University of Washington</h4>
    <p>
      This participatory map visualizes mosque locations across Seattle, Washington. As someone who identifies as Muslim, mosques hold personal
      significance to me as spaces of community, acceptance, and connection. Whether one practices a religion or not, mosques often 
      serve as important cultural landmarks that symbolize peace, unity, and support within local communities. 
      This interactive map allows users to explore mosque communities across Seattle and better understand their spatial presence 
      and role in the cityâ€™s cultural landscape.
      <a href="https://www.github.com/farcoolius/Islamic_Mosques" target="_blank">Project repo</a>.
      <i>Last update: Feb 2026</i>
    </p>
  </div>

  <script>
    let popup = null;

    let geojson = {
      type: 'FeatureCollection',
      features: []
    };

    let map = new maplibregl.Map({
      container: 'map',
      style: 'https://api.maptiler.com/maps/openstreetmap/style.json?key=mf1LXbJDeucSKBT1WUJC',
      center: [-122.3321, 47.6062],
      zoom: 12
    });

    // Load existing records
    window.addEventListener("load", async function () {
      try {
        let response = await fetch('https://islamic-mosques.herokuapp.com/api/get-record', { method: 'GET' });
        let data = await response.json();

        for (let i = 0; i < data.rows.length; i++) {
          geojson.features.push({
            type: 'Feature',
            properties: {
              contributor: data.rows[i].contributor,
              mosque_name: data.rows[i].mosque_name,
              year_established: data.rows[i].year_established,
              content: data.rows[i].content
            },
            geometry: {
              type: 'Point',
              coordinates: [data.rows[i].lng, data.rows[i].lat]
            }
          });
        }

        // IMPORTANT: update the source after data loads (if the source already exists)
        if (map.getSource('places')) {
          map.getSource('places').setData(geojson);
        }
      } catch (err) {
        console.error("Error loading records:", err);
      }
    });

    map.on("load", function () {
      map.addSource('places', {
        type: 'geojson',
        data: geojson
      });

      map.addLayer({
        id: 'placesLayer',
        type: 'circle',
        source: 'places',
        paint: {
          'circle-radius': 6,
          'circle-color': '#B42222',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });
    });

    // Hover popup
    map.on('mouseenter', 'placesLayer', function (e) {
      map.getCanvas().style.cursor = 'pointer';

      var coordinates = e.features[0].geometry.coordinates.slice(); // <-- FIXED
      var mosqueName = e.features[0].properties.mosque_name || "Unknown";
      var yearEstablished = e.features[0].properties.year_established || "N/A";
      var content = e.features[0].properties.content || "";
      var contributor = e.features[0].properties.contributor || "Anonymous";

      popup = new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(`
          <p><b>${mosqueName}</b> (${yearEstablished})</p>
          <p>${content}</p>
          <p><i>Added by:</i> ${contributor}</p>
        `)
        .addTo(map);
    });

    map.on('mouseleave', 'placesLayer', function () {
      map.getCanvas().style.cursor = '';
      if (popup) popup.remove();
    });

    // Click to add
    map.on('click', function (e) {
      if (popup) popup.remove();

      const popupContent = `
        <div id="popup">
          <input type="text" id="name" placeholder="Your name (optional)">
          <input type="text" id="mosque_name" placeholder="Mosque name (required)">
          <input type="number" id="year_established" placeholder="Year established (e.g., 1998)">
          <input type="text" id="content" placeholder="Notes / history (optional)">
          <button id="submit">Submit</button>
        </div>
      `;

      popup = new maplibregl.Popup({ closeOnClick: false })
        .setLngLat(e.lngLat)
        .setHTML(popupContent)
        .addTo(map);

      document.getElementById('submit').addEventListener('click', submitNewRecord);
      e.preventDefault();
    });

    async function submitNewRecord() {
      let contributor = document.getElementById('name').value;
      let mosqueName = document.getElementById('mosque_name').value;
      let yearEstablished = document.getElementById('year_established').value;
      let content = document.getElementById('content').value;
      let lngLat = popup.getLngLat();

      if (!mosqueName || mosqueName.trim().length === 0) {
        alert("Please enter a mosque name.");
        return;
      }

      let newRecord = new URLSearchParams();
      newRecord.append('contributor', contributor);
      newRecord.append('mosque_name', mosqueName);
      newRecord.append('year_established', yearEstablished);
      newRecord.append('content', content);
      newRecord.append('lng', lngLat.lng);
      newRecord.append('lat', lngLat.lat);

      let settings = { method: 'POST', body: newRecord };

      try {
        await fetch('https://islamic-mosques.herokuapp.com/api/add-record', settings);
      } catch (err) {
        console.error("Error submitting record:", err);
      } finally {
        if (popup) popup.remove();

        geojson.features.push({
          type: 'Feature',
          properties: {
            contributor: contributor,
            mosque_name: mosqueName,
            year_established: yearEstablished,
            content: content
          },
          geometry: {
            type: 'Point',
            coordinates: [lngLat.lng, lngLat.lat]
          }
        });

        if (map.getSource('places')) {
          map.getSource('places').setData(geojson);
        }
      }
    }
  </script>
</body>
</html>
</html>
